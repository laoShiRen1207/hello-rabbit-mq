## RabbitMQ 分布式事务

> 简述

分布式事务指事务的操作位于不同的节点，需要保证事务的 ACID 的特性。

例如在下单场景下，库存和订单如果不在同一个节点上，就涉及分布式事务。

> 分布式事务的方式

在分布式事务中，要实现分布式事务，无外乎几种方案。

### 两阶段提交 

两阶段提交（two-phase-commit）2PC 需要数据库支持，java 的组件有 atomikos 等。通过引入协调者来协调参与者的行为，并最终决定这些参与者是否要真正执行事务。

1. 协调者询问参与者事务是否执行成功，参与者发回事务执行结果。
2. 如果事务在每个参与者上都执行成功，事务协调者发送通知让参与者提交事务，否者协调者发送通知让参与者回滚事务。

需要注意的是，在准备阶段参与者执行了事务，但是还未提交，只有在提交阶段受到协调者发来的通知后，才进行提交或者回滚。

**存在的问题**

1. 2PC 是同步阻塞的，所有事务的参与者在等待其他事物响应的时候都处于同步阻塞的状态，无法进行其他操作。
2. 单点问题，事务协调者在 2PC 中起到了非常大的作用，发生故障将会造成很大影响，特别是在阶段2发生故障的时候，所有参与者会一直保持等待状态，无法完成其他操作。
3. 数据不一致，在阶段2，如果协调者只发送了部分 commit 消息，此时网络发生异常，那么只有部分参与者接收到了消息，也就是说只有部分参与者提交了事务，使得系统数据不一致。
4. 没有完善的容错机制。

### 补偿事务

TCC



